# Fix за проблема с Upgrade на обекти

## Проблем
Когато се обновява (upgrade) обект:
- Времето не се отброява правилно
- Обектът не се показва в червено в града
- `build_seconds` не се запазва в базата данни
- След връщане към парцела или града не се вижда напредъка

## Решение

### 1. База данни и Model
- Добавени `build_seconds`, `workers`, `building_type_id` към `fillable` в `CityObject` модела
- Колоните вече съществуват в базата, но не бяха достъпни за запис

### 2. Backend (CityController.php)

#### upgrade() метод:
- Добавена валидация за наличност на workers
- Правилно изчисляване на `finalSeconds` (не `finalMinutes`)
- Запазване на `build_seconds` в базата данни: `$object->build_seconds = $finalSeconds`
- Response връща пълен обект с ISO формат за `ready_at`
- Добавени всички необходими полета в response

#### save() метод:
- Запазва `build_seconds` при създаване на нови обекти

#### index() метод:
- Използва `build_seconds` от базата ако съществува
- Fallback към динамично изчисление ако липсва

### 3. Frontend

#### ObjectEditor.vue:
- Променен `remainingTimeText` да показва минути И секунди: `${minutes}m ${seconds}s`
- След upgrade обновява обекта с всички данни от response
- Презарежда workers данните след upgrade
- Бутонът за upgrade се скрива правилно с `isBuilding(object)`
- Добавени console.log за debugging

#### ParcelEditor.vue:
- Обединени двата `onMounted` hook-а в един
- Добавен `watch` за route path - автоматично презарежда обектите при връщане
- Interval за tick се стартира след зареждане на данните

#### CityPage.vue:
- Добавен `watch` за route path - автоматично презарежда при връщане към града
- Така обектите в upgrade ще се показват в червено (класът `building`)

## Как работи сега:

1. При upgrade:
   - Запазва `ready_at` (крайна дата)
   - Запазва `build_seconds` (време за строеж)
   - Запазва `properties['workers']` (информация за работниците)
   - Създава `occupied_workers` запис

2. В ObjectEditor:
   - Показва оставащото време с минути и секунди
   - Обновява се всяка секунда чрез `currentTime.value`
   - Бутонът за upgrade изчезва докато процесът тече

3. В ParcelEditor:
   - Автоматично презарежда обектите при връщане от ObjectEditor
   - Показва времето под иконката на обекта
   - Tick interval обновява UI всяка секунда

4. В CityPage:
   - Автоматично презарежда обектите при връщане
   - Обекти в upgrade се показват в червено (класът `building`)
   - `isBuilding()` функцията проверява дали `ready_at` е в бъдещето

## Важни моменти:

- `build_seconds` се запазва в БД колона за бърз достъп
- `properties['workers']` се използва за изчисление ако `build_seconds` липсва
- `ready_at` се форматира като ISO string в API response
- Reactive updates чрез `watch` за route промени
- Tick intervals за real-time отброяване

## Тестване:

1. Отвори обект и кликни "Обновяване на ниво"
2. Избери workers и кликни "Започни обновяване"
3. Трябва да видиш времето да се отброява (например "7m 23s")
4. Върни се към парцела - трябва да виждаш времето под иконката
5. Върни се към града - обектът трябва да е в червено
6. След изтичане на времето обектът става син и нивото се увеличава
