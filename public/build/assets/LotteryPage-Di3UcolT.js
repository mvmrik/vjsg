import{a as O,_ as pe,r as i,u as he,c as g,w as me,o as _e,b as c,d as E,e as $,f as S,g as s,t as l,h as f,i as fe,j as Q,k as A,F as M,l as P,n as L,m as B,p as r}from"./app-BZlJZTZ9.js";const ge=10*1e3;let v={jackpot:null,ts:0,pending:null};async function H(G=!1){const u=Date.now();return!G&&v.jackpot!=null&&u-v.ts<ge?{success:!0,jackpot:v.jackpot}:(v.pending||(v.pending=(async()=>{try{const _=await O.get("/api/events/lottery/jackpot");return _&&_.data&&_.data.success?(v.jackpot=_.data.jackpot,v.ts=Date.now(),{success:!0,jackpot:v.jackpot}):{success:!1}}catch(_){throw _}finally{v.pending=null}})()),v.pending)}function ye(){v.jackpot=null,v.ts=0}const we={class:"lottery-page"},ke={class:"d-flex align-items-center"},be={class:"jackpot-badge ms-3"},xe={class:"fw-bold ms-2"},je={key:0,class:"text-center"},Ce={key:1},Ee={key:0},Se={key:1},Me={class:"lottery-layout"},Pe={class:"lottery-area"},Ne={class:"lottery-grid"},De=["onClick"],Je={class:"sidebar-area"},$e={class:"selection-summary d-flex flex-column gap-3"},Le={class:"selected-chips"},Oe={class:"small text-muted mb-1"},Te={class:"chips d-flex flex-wrap gap-2"},Ve={key:0,class:"text-muted"},Fe={class:"cost-block"},ze={class:"small text-muted mb-1"},Ae={class:"cost-badge"},Be={class:"expected-payouts"},He={class:"small text-muted mb-1"},Ge={class:"table table-sm mb-0"},Re={class:"align-middle"},We={class:"text-end align-middle fw-bold"},Ie={class:"mt-4"},Ue={class:"table table-sm"},qe={class:"mt-2 d-flex justify-content-between align-items-center"},Ke={class:"small text-muted"},Qe={class:"pagination mb-0"},Xe=["onClick"],X=7,Ye=1,Ze={__name:"LotteryPage",setup(G){const u=fe("$t"),_=i(!0),N=i(null),Y=Array.from({length:X*X},(e,t)=>t+1),d=i([]),Z=i(""),ee=i(""),k=i(0),b=i(0),T=he(),x=i([]),D=i(!1),J=i(null),y=i([]),j=i(!1),h=i(1),C=i(10),w=g(()=>Math.max(1,Math.ceil((y.value||[]).length/C.value))),te=g(()=>{const e=(h.value-1)*C.value;return(y.value||[]).slice(e,e+C.value)});function V(e){e<1&&(e=1),e>w.value&&(e=w.value),h.value=e}me(y,()=>{h.value>w.value&&(h.value=w.value)});const se=async()=>{_.value=!0;try{const e=await O.get("/api/events/current");e.data.success&&(N.value=e.data.event,N.value&&await R())}catch(e){console.error("Failed to load event",e)}finally{_.value=!1}},R=async()=>{try{const e=await H();e&&e.success&&(k.value=e.jackpot)}catch{}},ae=async()=>{try{const e=await H();e&&e.success&&(k.value=e.jackpot,b.value=e.jackpot)}catch{}};_e(()=>{se(),W(),ae()});const W=async()=>{try{const e=await O.get("/api/events/lottery/history");e.data.success&&(y.value=e.data.entries||[])}catch{}},ne=e=>{if(D.value)return;const t=d.value.indexOf(e);if(t===-1){if(d.value.length>=9)return;d.value.push(e)}else d.value.splice(t,1)},I=g(()=>{const e=d.value.length,t=e===6?1:e===7?10:e===8?100:e===9?1e3:0;return e>=6?Ye*t:0}),U=g(()=>d.value.length>=6&&d.value.length<=9&&!D.value&&(T.user?.balance??0)>=I.value);g(()=>T.user?.balance??0);const le=async()=>{if(U.value)try{try{const t=await H(!0).catch(()=>null);if(t&&t.success){const a=t.jackpot??0;if(a<b.value){const o=F("events.jackpot_decreased",{old:b.value,new:a});window.dispatchEvent(new CustomEvent("show-toast",{detail:{message:o,type:"warning"}})),b.value=a,k.value=a;return}}}catch{}const e=await O.post("/api/events/lottery/enter",{numbers:d.value,observed_jackpot:b.value});if(e.data.success){window.dispatchEvent(new CustomEvent("show-toast",{detail:{message:u("events.entry_success")||"Entry successful",type:"success"}}));const t=e.data.draw||[],a=e.data.entry||null,o=e.data.matches??(a?(a.numbers||[]).filter(p=>t.includes(p)).length:0),m=e.data.payout??(a?a.payout:0);try{if(D.value=!0,await ce(t),o>=3){const p=F("events.matched",{count:o,payout:m});window.dispatchEvent(new CustomEvent("show-toast",{detail:{message:p,type:"success"}}))}else{const p=F("events.no_match",{count:o});window.dispatchEvent(new CustomEvent("show-toast",{detail:{message:p,type:"info"}}))}ye(),await R(),await T.fetchUserData(),await W(),j.value=!0,e.data.new_balance!=null}catch(p){console.error("Draw animation error",p)}finally{D.value=!1}}else{const t=e.data.message||"Error";window.dispatchEvent(new CustomEvent("show-toast",{detail:{message:t,type:"error"}}))}}catch(e){const t=e?.response;if(t&&t.data){let a="";if(t.data.message)a=t.data.message;else if(t.data.errors){const o=Object.values(t.data.errors)[0];a=Array.isArray(o)?o[0]:String(o)}else a=JSON.stringify(t.data);window.dispatchEvent(new CustomEvent("show-toast",{detail:{message:a,type:"error"}}))}else window.dispatchEvent(new CustomEvent("show-toast",{detail:{message:"Server error",type:"error"}}))}};function oe(){x.value=[],J.value=null,Z.value="",ee.value="",d.value=[],j.value=!1}function F(e,t={}){let a=u(e);return typeof a!="string"&&(a=String(a||e)),Object.keys(t||{}).forEach(o=>{a=a.replace(new RegExp(":"+o,"g"),String(t[o]))}),a}function q(e){return new Promise(t=>setTimeout(t,e))}async function ce(e){x.value=[];for(let t=0;t<e.length;t++){const a=e[t];let o=25+t*10,m=30;for(let p=0;p<o;p++){const z=Math.floor(Math.random()*49)+1;J.value=z,await q(m),m=Math.min(200,m+5)}J.value=a,x.value.push(a),await q(300)}}const re=g(()=>k.value),K={6:1,5:.2,4:.04,3:.01},ie=g(()=>{const e={},t=k.value||0;return Object.keys(K).forEach(a=>{const o=Number(a);let m=Math.floor((K[o]||0)*t);o===3&&m<1&&(m=1),e[o]=m}),e});function ue(e){return e==null?"-":e===0?"0":e.toLocaleString(void 0,{maximumFractionDigits:0})}function de(e){return{"lottery-cell":!0,selected:d.value.includes(e),drawn:x.value.includes(e),highlighted:J.value===e,"selected-drawn":d.value.includes(e)&&x.value.includes(e)}}return(e,t)=>{const a=S("c-button"),o=S("c-card-header"),m=S("c-spinner"),p=S("c-card-body"),z=S("c-card");return r(),c("div",we,[E(z,null,{default:$(()=>[E(o,{class:"d-flex justify-content-between align-items-center"},{default:$(()=>[s("div",ke,[s("strong",null,l(f(u)("events.lottery")),1),s("span",be,[Q(l(f(u)("events.jackpot"))+" ",1),s("span",xe,l(re.value),1)])]),s("div",null,[E(a,{color:"primary",disabled:!U.value&&!j.value,onClick:t[0]||(t[0]=n=>j.value?oe():le())},{default:$(()=>[Q(l(j.value?f(u)("events.new_game")||"New game":f(u)("events.play")||"Play"),1)]),_:1},8,["disabled"])])]),_:1}),E(p,null,{default:$(()=>[_.value?(r(),c("div",je,[E(m)])):(r(),c("div",Ce,[N.value?A("",!0):(r(),c("p",Ee,l(f(u)("events.no_active")),1)),N.value?(r(),c("div",Se,[s("div",Me,[s("div",Pe,[s("div",Ne,[(r(!0),c(M,null,P(f(Y),n=>(r(),c("button",{key:n,class:L(de(n)),onClick:ve=>ne(n)},l(n),11,De))),128))])]),s("aside",Je,[s("div",$e,[s("div",Le,[s("div",Oe,l(f(u)("events.selected")),1),s("div",Te,[(r(!0),c(M,null,P(d.value,n=>(r(),c("span",{key:n,class:"chip"},l(n),1))),128)),d.value.length===0?(r(),c("span",Ve,"—")):A("",!0)])]),s("div",Fe,[s("div",ze,l(f(u)("events.cost")),1),s("div",Ae,l(I.value||0),1)]),s("div",Be,[s("div",He,l(f(u)("events.expected_payouts")),1),s("table",Ge,[s("tbody",null,[(r(),c(M,null,P([3,4,5,6],n=>s("tr",{key:n},[s("td",Re,l(n)+" "+l(f(u)("events.match_suffix")),1),s("td",We,l(ue(ie.value[n]||0)),1)])),64))])])])])])]),s("div",Ie,[t[4]||(t[4]=s("h5",null,"History",-1)),s("table",Ue,[t[3]||(t[3]=s("thead",null,[s("tr",null,[s("th",null,"When"),s("th",null,"Numbers"),s("th",null,"Stake"),s("th",null,"Payout")])],-1)),s("tbody",null,[(r(!0),c(M,null,P(te.value,n=>(r(),c("tr",{key:n.id},[s("td",null,l(new Date(n.created_at).toLocaleString()),1),s("td",null,l((n.numbers||[]).join(", ")),1),s("td",null,l(n.stake),1),s("td",null,l(n.payout??"-"),1)]))),128))])]),s("nav",qe,[s("div",Ke,"Показани: "+l((h.value-1)*C.value+1)+" - "+l(Math.min(h.value*C.value,y.value.length))+" от "+l(y.value.length),1),s("ul",Qe,[s("li",{class:L(["page-item",{disabled:h.value===1}])},[s("a",{class:"page-link",href:"#",onClick:t[1]||(t[1]=B(n=>V(h.value-1),["prevent"]))},"«")],2),(r(!0),c(M,null,P(w.value,n=>(r(),c("li",{key:n,class:L(["page-item",{active:h.value===n}])},[s("a",{class:"page-link",href:"#",onClick:B(ve=>V(n),["prevent"])},l(n),9,Xe)],2))),128)),s("li",{class:L(["page-item",{disabled:h.value===w.value}])},[s("a",{class:"page-link",href:"#",onClick:t[2]||(t[2]=B(n=>V(h.value+1),["prevent"]))},"»")],2)])])])])):A("",!0)]))]),_:1})]),_:1})])}}},tt=pe(Ze,[["__scopeId","data-v-70e1d522"]]);export{tt as default};
